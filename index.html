<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Traces Netcoupe</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <link rel="icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="https://unpkg.com/leaflet@1.0.2/dist/leaflet.css">
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sidebar-v2@0.4.0/css/leaflet-sidebar.css" integrity="sha256-FIZlRBXnW3JL4Pb7oAW2QNCGAG5uJqYlFbZb9qAKaso=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.css">
    <link rel="stylesheet" href="css/traces.css">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/leaflet@1.0.2/dist/leaflet.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sidebar-v2@0.4.0/js/leaflet-sidebar.js" integrity="sha256-NQzshErvg7W7EhLN0umegsGFdejTaaAWM/vzq1yfSEg=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>
    <script src="js/common.js"></script>
    <script src="js/application.js"></script>
    <script src="js/airspace.js"></script>
</head>
<body>    
    <div id="sidebar" class="sidebar collapsed">
        <!-- Nav tabs -->
        <div class="sidebar-tabs">
            <ul role="tablist">
                <li><a href="#home" role="tab"><i class="fa fa-bars"></i></a></li>
                <li><a href="#settings" role="tab"><i class="fa fa-gear"></i></a></li>
            </ul>
        </div>

        <!-- Tab panes -->
        <div class="sidebar-content">
            <div class="sidebar-pane" id="home">
                <h1 class="sidebar-header">
                    Cumulative Tracks
                    <span class="sidebar-close"><i class="fa fa-caret-left"></i></span>
                </h1>
                <div class="container">
                    <div class="row">
                    <div class="col-sm-6">
                        <div class="item">Analyse du:</div>
                    </div>
                    <div class="col-sm-6">
                        <div id="start-date" class="item"></div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-sm-6">
                        <div class="item">Durée calcul:</div>
                    </div>
                    <div class="col-sm-6">
                        <div id="duration" class="item"></div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-sm-6">
                        <div class="item">Nb Vols:</div>
                    </div>
                    <div class="col-sm-2">
                        <div id="processed-flights-count" class="item"></div>
                    </div>
                    <div class="col-sm-2"><span>/</span></div>
                    <div class="col-sm-2">
                        <div id="flights-count" class="item"></div>
                    </div>
                </div>
                </div>
            </div>

            <div class="sidebar-pane" id="settings">
                <h1 class="sidebar-header">Configuration<span class="sidebar-close"><i class="fa fa-caret-left"></i></span></h1>
                <div class="container">
                    <div class="row" id="switch-airspace-container">
                        <div class="col-sm-12">
                            <div class="custom-control custom-switch">
                                <input type="checkbox" class="custom-control-input d-none" id="switch-airspace">
                                <label class="custom-control-label" for="switch-airspace">Espace Aérien</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

	<div id="map"></div>
</body>
<script src="js/interface.js"></script>
<script>
var isAirspaceShown = false;

// --- Map related --
var zoomLevel = 6;
var maxZoomLevel = 12;
var center = [47.5, 4.8];
//center = [45.5917, 5.8813];

var tracksMetaData = null;

// Create the map
var _map = L.map('map', {
    maxBoundsViscosity: 1
}).setView(center, zoomLevel);
var sidebar = L.control.sidebar('sidebar').addTo(_map);

// ----- Load MetaData -----
$.ajax({
            url: "/tracks/latest-tracks-metadata.json",
            type: 'GET',
            context: document.body,
            success: function(result) {
                // Get result metadata
                metadata = result;
                tracksMetaData = result;
                targetDate = moment(metadata.targetDate, "YYYY_MM_DD");
                startDate = moment(metadata.startDate, "YYYY_MM_DD HH:mm:ss");

                targetDateToDisplay = targetDate.format("DD/MM/YYYY");
                startDateToDisplay = moment(startDate).format("DD/MM/YYYY HH:mm:ss");
                duration = metadata.duration;
                flightsCount = metadata.flightsCount;
                processedFlightsCount = metadata.processedFlightsCount;

                // --- Init interface ---
                // --- Populate information panel
                $('#target-date').html(targetDateToDisplay);
                $('#start-date').html(startDateToDisplay);
                $('#duration').html(duration);
                $('#flights-count').html(flightsCount);
                $('#processed-flights-count').html(processedFlightsCount);

                addImageOverlay();  // Add tracks image overlay
            }
        });

// --- Load Airspace ---
setupAirspace();

function addImageOverlay() {
  // add a marker in the given location
  //L.marker(tracksMetaData.boundingBoxUpperLeft).addTo(_map); 
  //L.marker(tracksMetaData.boundingBoxLowerRight).addTo(_map);

    var imageUrl = '/tracks/latest-tracks.png',
    imageBounds = [ tracksMetaData.boundingBoxUpperLeft, tracksMetaData.boundingBoxLowerRight];
    L.imageOverlay(imageUrl, imageBounds).addTo(_map);

    // Map Bounds : add margin and set
    const boundPadding = 10;
    maxBounds = imageBounds.slice();
    maxBounds[0][0] -= boundPadding;
    maxBounds[0][1] -= boundPadding;
    maxBounds[1][0] += boundPadding;
    maxBounds[1][1] += boundPadding;

    //L.marker(maxBounds[0]).addTo(_map);
    //L.marker(maxBounds[1]).addTo(_map);

    _map.setMaxBounds(maxBounds);     // Max bounds: preventes map from panning
};

// Set up the OSM layer
// var OpenStreetMap_Mapnik = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
// 	maxZoom: 19,
// 	attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
// });
// OpenStreetMap_Mapnik.addTo(_map);

var Thunderforest_Outdoors = L.tileLayer('https://{s}.tile.thunderforest.com/outdoors/{z}/{x}/{y}.png?apikey={apikey}', {
	attribution: '&copy; <a href="http://www.thunderforest.com/">Thunderforest</a>, &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
    apikey: '45799462d9f6496aba635de79c086ea2',
    minZoom: zoomLevel,
	maxZoom: maxZoomLevel
});
Thunderforest_Outdoors.addTo(_map);

  // ---------- Document loaded ----------
  $(function () {
  });
</script>